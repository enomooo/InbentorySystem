@page "/shohin/delete/select"
@using InbentorySystem.Data
@using InbentorySystem.Data.Models
@inject IShohinRepository ShohinRepo
@inject NavigationManager NavManager

<PageTitle>商品削除対象選択</PageTitle>

<h1>商品削除対象選択</h1>

<button class="btn btn-secondary mb-3" @onclick="GoBack">
	<span class="pointer-event oi-arrow-left"></span>　商品管理メニューへ戻る
</button>

@if (IsLoading)
{
	<p><em>データを読み込み中です...</em></p>
}
else if (!string.IsNullOrEmpty(ErrorMessage))
{
	<div class="alert alert-danger">@ErrorMessage</div>
}
else if (ShohinList == null || !ShohinList.Any())
{
	<div class="alert alert-warning">該当する商品が見つかりませんでした。</div>
}
else
{
	<p>検索結果: **@ShohinList.Count 件** から削除対象を選択してください。</p>
	<table class="table table-striped table-bordered">
		<thead class="thead-dark">
			<tr>
				<th>コード</th>
				<th>商品名（漢字）</th>
				<th>商品名（かな）</th>
				<th class="text-end">仕入値</th>
				<th class="text-end">売値</th>
				<th>仕入れ先コード</th>
				<th>操作</th> @* 削除ボタン用の列*@
			</tr>
		</thead>
		<tbody>
			@foreach (var shohin in ShohinList)
			{
				<tr>
					<td>@shohin.ShohinCode</td>
					<td>@shohin.ShohinMeiKanji</td>
					<td>@shohin.ShohinMeiKana</td>
					<td class="text-end">@shohin.Shiirene.ToString("N0")</td>
					<td class="text-end">@shohin.Urine.ToString("N0")</td>
					<td>@shohin.ShiiresakiCode</td>
					<td>
						<button class="btn btn-danger btn-sm" @onclick="@(() => NavigateToDelete(shohin.ShohinCode))">
							削除
						</button>
					</td>
				</tr>
			}
		</tbody>
	</table>
}

@code {
	[Parameter]
	[SupplyParameterFromQuery]

	// 検索キーワード
	public string q { get; set; } = string.Empty;
	private List<ShohinModel> ShohinList { get; set; } = new();
	private bool IsLoading = true;
	private string ErrorMessage = string.Empty;

	/// <summary>
	/// ページ読み込み時に検索条件に応じた商品データ取得
	/// </summary>
	/// <returns></returns>
	protected override async Task OnInitializedAsync()
	{
		await LoadDataAsync();
	}

	/// <summary>
	/// 検索条件に応じてデータを取得
	/// </summary>
	/// <returns></returns>
	private async Task LoadDataAsync()
	{
		IsLoading = true;
		ErrorMessage = string.Empty;

		if (string.IsNullOrEmpty(q))
		{
			ErrorMessage = "検索条件が不正です。";
			IsLoading = false;
			return;
		}

		try
		{
			if (q.ToLower() == "all")
			{
				ShohinList = await ShohinRepo.GetAllAsync();
			}
			else
			{
				var keyword = Uri.UnescapeDataString(q);
				ShohinList = await ShohinRepo.SearchByKeywordAsync(keyword);
			}
		}
		catch (Exception ex)
		{
			ErrorMessage = $"データの取得中にエラーが発生しました: {ex.Message}";
			ShohinList = new List<ShohinModel>();
		}
		finally
		{
			IsLoading = false;
		}
	}

	/// <summary>
	/// 指定された商品コードの削除確認画面へ遷移
	/// </summary>
	/// <param name="shohinCode"></param>
	private void NavigateToDelete(string shohinCode)
	{
		NavManager.NavigateTo($"/shohin/delete/{shohinCode}");
	}

	private void GoBack()
	{
		NavManager.NavigateTo("/shohin/menu");
	}
}
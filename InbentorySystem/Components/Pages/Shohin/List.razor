@page "/shohin/list"
@using InbentorySystem.Data
@using InbentorySystem.Data.Models
@inject ShohinRepository ShohinRepo
@inject NavigationManager NavManager

<PageTitle>商品検索結果</PageTitle>
<h1>商品検索結果一覧</h1>

<button class="btn btn-secondary mb-3" @onclick="GoBack">
	<span class="pointer-event oi-arrow-left"></span>商品管理メニューへ戻る
</button>

@if (IsLoading)
{
	<p><em>データを読み込み中です...</em></p>
}
else if (!string.IsNullOrEmpty(ErrorMessage))
{
	<div class="alert alert-danger">@ErrorMessage</div>
}
else if (ShohinList == null || !ShohinList.Any())
{
	<div class="alert alert-warning">該当する商品が見つかりませんでした。</div>
}
else
{
	<p>検索結果: **@ShohinList.Count 件**</p>
	<table class="table table-striped table-bordered">
		<thead class="thead-dark">
			<tr>
				<th>コード</th>
				<th>商品名（漢字）</th>
				<th>商品名（かな）</th>
				<th class="text-end">仕入値</th>
				<th class="text-end">売値"</th>
				<th>仕入先コード</th>
			</tr>
		</thead>

		<tbody>
			@foreach (var shohin in ShohinList)
			{
				<tr>
					<td>@shohin.ShohinCode</td>
					<td>@shohin.ShohinMeiKanji</td>
					<td>@shohin.ShohinMeiKana</td>
					<td class="text-end">@shohin.ShiireKakaku.ToString("N0")</td>
					<td class="text-end">@shohin.HanbaiKakaku.ToString("N0")</td>
					<td>@shohin.ShiiresakiCode</td>
				</tr>
			}
		</tbody>
	</table>
}

@code{
	[Parameter]
	[SupplyParameterFromQuery]
	public string q { get; set; } = string.Empty;

	private List<ShohinModel> ShohinList { get; set; } = new();
	private bool IsLoading = true;
	private string ErrorMessage = string.Empty;

	protected override async Task OnInitializedAsync()
	{
		await LoadDataAsync();
	}

	private async Task LoadDataAsync()
	{
		IsLoading = true;
		ErrorMessage = string.Empty;

		if (string.IsNullOrEmpty(q))
		{
			ErrorMessage = "検索条件が不正です。";
			IsLoading = false;
			return;
		}

		try
		{
			// q="all"の場合は全件取得(GetAllAsync)を実行
			if (q.ToLower() == "all")
			{
				// TODO:ShohinRepositoryの実装で在庫数を含めないSQLを実行する必要がある（そもそも徐長？）
				ShohinList = await ShohinRepo.GetAllAsync();
			}
			else
			{
				var keyword = Uri.UnescapeDataString(q);
				ShohinList = await ShohinRepo.SearchAsync(keyword);
			}
		}
		catch(Exception ex)
		{
			ErrorMessage = $"データの取得中にエラーが発生しました:{ex.Message}";
			ShohinList = new List<ShohinModel>();
		}
		finally
		{
			IsLoading = false;
		}
	}

	private void GoBack()
	{
		NavManager.NavigateTo("/shohin/index");
	}
}
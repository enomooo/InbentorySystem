@page "/shohin/edit/"
@using InbentorySystem.Data
@using InbentorySystem.Data.Models
@inject ShohinRepository ShohinRepo
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>商品修正:@ShohinCode</PageTitle>

<h1>商品修正</h1>

<button class="btn btn-secondary mb-3" @onclick="GoBack">
	<span class="oi oi-arrow-left"></span>選択画面へ戻る
</button>

@if (IsLoading)
{
	<p><em>データを読み込み中です...</em></p>
}
else if (!string.IsNullOrEmpty(ErrorMessage))
{
	<div class="alert alert-danger">@ErrorMessage</div>
}
else if (Model == null)
{
	<div class="alert alert-warning">指定された商品コード（@ShohinCode）は見つかりませんでした。</div>
}
else
{
	<div class="card p-4">
		<h2>商品修正フォーム（@Model.ShohinCode）</h2>

		<EditForm Model="@Model" OnValidSubmit="UpdateAsync">
			<DataAnnotationsValidator />

			<div class="row mb-3">
				<label for="shohinCode" class="col-sm-3 col-form-label">商品コード</label>
				<div class="col-sm-5">
					<InputText id="shohinCode" @bind-Value="Model.ShohinCode" class="form-control" readonly />
				</div>
			</div>

			<div class="row mb-3">
				<label for="kanjiName" class="col-sm-3 col-form-label">商品名（漢字）</label>
				<div class="col-sm-7">
					<InputText id="kanjiName" @bind-Value="Model.ShohinMeiKanji" class="form-control" />
					<ValidationMessage For="@(() => Model.ShohinMeiKanji)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="kanaName" class="col-sm-3 col-form-label">商品名（かな））</label>
				<div class="col-sm-7">
					<InputText id="kanaName" @bind-Value="Model.ShohinMeiKana" class="form-control" />
					<ValidationMessage For="@(() => Model.ShohinMeiKana)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="shiire" class="col-sm-3 col-form-label">仕入値</label>
				<div class="col-sm-3">
					<InputNumber id="shiire" @bind-Value="Model.Shiirene" class="form-control" />
					<ValidationMessage For="@(() => Model.Shiirene)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="hanbai" class="col-sm-3 col-form-label">売値</label>
				<div class="col-sm-3">
					<InputNumber id="hanbai" @bind-Value="Model.Urine" class="form-control" />
					<ValidationMessage For="@(() => Model.Urine)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="ShiireCode" class="col-sm-3 col-form-label">仕入先コード</label>
				<div class="col-sm-4">
					<InputText id="shiireCode" @bind-Value="Model.ShiiresakiCode" class="form-control" />
					<ValidationMessage For="@(() => Model.ShiiresakiCode)" />
				</div>
			</div>

			<div class="d-flex gap-3 mt-4">
				<button type="submit" class="btn btn-warning">修正実行</button>
			</div>
			@if (!string.IsNullOrEmpty(UpdateErrorMessage))
			{
				<div class="alert alert-danger mt-3">@UpdateErrorMessage</div>
			}
		</EditForm>
	</div>
}

@code {
	[Parameter]
	public string ShohinCode { get; set; } = string.Empty;
	private List<ShohinModel> ShohinList { get; set; } = new();

	private ShohinModel? Model { get; set; }
	private bool IsLoading = true;
	private string ErrorMessage = string.Empty;
	private string UpdateErrorMessage = string.Empty;

	/// <summary>
	/// URLの商品コードを元にデータを取得
	/// </summary>
	/// <returns></returns>
	protected override async Task OnInitializedAsync()
	{
		await LoadDataAsync();
	}

	/// <summary>
	/// URLの商品コードを元にデータを取得
	/// </summary>
	/// <returns></returns>
	private async Task LoadDataAsync()
	{
		IsLoading = true;
		ErrorMessage = string.Empty;

		if (string.IsNullOrEmpty(ShohinCode))
		{
			ErrorMessage = string.Empty;
			IsLoading = false;
			return;
		}

		try
		{
			// ShohinRepositoryのGetByCodeAsyncを使ってデータを取得
			Model = await ShohinRepo.GetByCodeAsync(ShohinCode);

			if (Model == null)
			{
				ErrorMessage = $"商品コード'{ShohinCode}'のデータが見つかりませんでした";
			}
		}
		catch (Exception ex)
		{
			ErrorMessage = $"データの読み込み中にエラーが発生しました: {ex.Message}";
		}
		finally
		{
			IsLoading = false;
		}
	}

	/// <summary>
	/// 修正処理の実行
	/// </summary>
	/// <returns></returns>
	private async Task UpdateAsync()
	{
		if (Model == null) return;

		UpdateErrorMessage = string.Empty;
		try
		{
			await ShohinRepo.UpdateAsync(Model);
			NavigationManager.NavigateTo("/shohin/index");
		}
		catch (Exception ex)
		{
			UpdateErrorMessage = $"修正中にシステムエラーが発生しました: {ex.Message}";
		}
	}

	/// <summary>
	/// 修正選択画面に戻る処理
	/// </summary>
	private void GoBack()
	{
		NavigationManager.NavigateTo("/shohin/edit/select", forceLoad: true);
	}



}
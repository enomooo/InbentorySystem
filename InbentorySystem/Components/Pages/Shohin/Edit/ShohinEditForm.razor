@page "/shohin/edit/form"
@using InbentorySystem.Data
@using InbentorySystem.Services
@using InbentorySystem.Data.Models
@inject IShohinService ShohinService
@inject NavigationManager NavManager
@inject IShohinRepository ShohinRepo

<h1>商品修正フォーム</h1>

@if (EditModel == null)
{
	<div class="alert alert-warning">
		修正対象が選択されていません。<a href="/shohin/index">商品管理メニューに戻る</a>
	</div>
}
else
{
	<EditForm Model="@EditModel" OnVaildSubmit="UpdateShohinAsync">
		<DataAnnotationsValidator />
		<validationSummary />

		<div class="card p-4">
			<div class="row mb-3">
				<label for="ShohinCode" class="col-sm-3 col-form-label">商品コード</label>
				<div class="col-sm-5">
					<InputText id="ShohinCode" @bind-Value="EditModel.ShohinCode" Disabled />
				</div>
			</div>

			<div class="row mb-3">
				<label for="KanjiName" class="col-sm-3 col-form-label">商品名（漢字）</label>
				<div class="col-sm-7">
					<InputText id="KanjiName" @bind-Value="EditModel.ShohinMeiKanji" />
					<ValidationMessage For="@(() => EditModel.ShohinMeiKanji)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="KanaName" class="col-sm-3 col-form-label">商品名（かな）</label>
				<div class="col-sm-7">
					<InputText id="KanaName" @bind-Value="EditModel.ShohinMeiKana" />
					<ValidationMessage For="@(() => EditModel.ShohinMeiKana)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="Shiirene" class="col-sm-3 col-form-label">仕入値</label>
				<div class="col-sm-3">
					<InputNumber id="Shiirene" @bind-Value="EditModel.Shiirene" />
					<ValidationMessage For="@(() => EditModel.Shiirene)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="Urine" class="col-sm-3 col-form-label">売値</label>
				<div class="col-sm-3">
					<InputNumber id="Urine" @bind-Value="EditModel.Urine" />
					<ValidationMessage For="@(() => EditModel.Urine)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="ShiiresakiCode" class="col-sm-3 col-form-label">仕入先コード</label>
				<div class="col-sm-4">
					<InputText id="ShiiresakiCode" @bind-Value="EditModel.ShiiresakiCode" />
					<ValidationMessage For="@(() => EditModel.ShiiresakiCode)" />
				</div>
			</div>

			<div class="d-flex gap-3 mt-4">
				<button type="submit" class="btn btn-primary">修正を保存</button>
				<button type="button" class="btn btn-secondary" @onclick="Cancel">キャンセル</button>
			</div>

			@if (!string.IsNullOrEmpty(ErrorMessage))
			{
				<div class="alert alert-danger mt-3">@ErrorMessage</div>
			}
		</div>
	</EditForm>
}

@code {

	// 修正対象の商品データ
	private ShohinModel? EditModel;
	private string ErrorMessage = string.Empty;
	public string ShohinCode { get; set; } = string.Empty;
	public ShohinModel Shohin { get; set; } = new();


	/// <summary>
	/// 選択された商品情報を取得
	/// </summary>
	protected override void OnInitialized()
	{
		EditModel = ShohinService.GetLastEditedShohin();
	}

	/// <summary>
	/// 商品情報を更新する
	/// </summary>
	/// <returns></returns>
	private async Task UpdateShohinAsync()
	{
		ErrorMessage = string.Empty;

		if (EditModel == null)
		{
			ErrorMessage = "修正対象の商品が存在しません。";
			return;
		}

		try
		{
			ShohinService.SetLastEditedShohin(EditModel);
			await ShohinRepo.UpdateAsync(EditModel);
			NavManager.NavigateTo("/shohin/menu", forceLoad: true);
		}
		catch (Exception ex)
		{
			ErrorMessage = $"修正中にエラーが発生しました: {ex.Message}";
		}
	}

	// 商品管理メニューに戻る
	private void Cancel()
	{
		NavManager.NavigateTo("/shohin/menu");
	}

}
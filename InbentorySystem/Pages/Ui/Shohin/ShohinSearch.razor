@page "/shohin/search"
@using InbentorySystem.Data.Models
@using InbentorySystem.Infrastructure
@using InbentorySystem.Infrastructure.Repository
@using InbentorySystem.Infrastructure.Interfaces
@inject IShohinRepository ShohinRepo
@inject NavigationManager NavManager

<PageTitle>商品検索結果</PageTitle>
<h1>商品検索結果一覧</h1>

@if (IsLoading)
{
	<p><em>データを読み込み中です...</em></p>
}
else if (!string.IsNullOrEmpty(ErrorMessage))
{
	<div class="alert alert-danger">@ErrorMessage</div>
}
else if (ShohinList == null || !ShohinList.Any())
{
	<div class="alert alert-warning">該当する商品が見つかりませんでした。</div>
}
else
{
	<p>検索結果: **@ShohinList.Count 件**</p>
	<table class="table table-striped table-bordered">
		<thead class="thead-dark">
			<tr>
				<th>商品コード</th>
				<th>商品名（漢字）</th>
				<th>商品名（かな）</th>
				<th class="text-end">仕入値</th>
				<th class="text-end">売値</th>
				<th>仕入先コード</th>
			</tr>
		</thead>

		<tbody>
			@foreach (var shohin in ShohinList)
			{
				<tr>
					<td>@shohin.ShohinCode</td>
					<td>@shohin.ShohinMeiKanji</td>
					<td>@shohin.ShohinMeiKana</td>
					<td class="text-end">@shohin.Shiirene.ToString("N0")</td>
					<td class="text-end">@shohin.Urine.ToString("N0")</td>
					<td>@shohin.ShiiresakiCode</td>
				</tr>
			}
		</tbody>
	</table>
}

<button class="btn btn-secondary w-100 mb-3" @onclick="GoBack">
	<span class="pointer-event oi-arrow-left"></span>商品管理メニューへ戻る
</button>

@code {
	[Parameter]
	[SupplyParameterFromQuery]
	// URLクエリから渡される検索キーワード
	public string q { get; set; } = string.Empty;
	private List<ShohinModel> ShohinList { get; set; } = new();
	private bool IsLoading = true;
	private string ErrorMessage = string.Empty;

	/// <summary>
	/// URLの商品コードを元にデータを取得
	/// </summary>
	/// <returns></returns>
	protected override async Task OnInitializedAsync()
	{
		await LoadDataAsync();
	}

	/// <summary>
	/// URLの商品コードを元にデータを取得
	/// </summary>
	/// <returns></returns>
	private async Task LoadDataAsync()
	{
		Console.WriteLine($"[DEBUG] q = {q}");
		Console.WriteLine($"[DEBUG] ShohinRepo is null? {ShohinRepo == null}");

		if (ShohinRepo == null)
		{
			ErrorMessage = "システムエラー：商品リポジトリが初期化されていません";
			IsLoading = false;
			return;
		}

		IsLoading = true;
		ErrorMessage = string.Empty;

		try
		{
			string keyword;
			if (string.IsNullOrEmpty(q))
			{
				keyword = "all";
				Console.WriteLine("[DEBUG] Empty query treated as 'all'.");
			}

			else
			{
				// Blazorが自動でデコードする（Uri.UnescapeDataStringは不要）
				keyword = q;
			}
			ShohinList = keyword.ToLower() == "all"
					? await ShohinRepo.GetAllAsync()
					: await ShohinRepo.SearchByKeywordAsync(keyword);
		}
		catch (Exception ex)
		{
			Console.WriteLine($"[EXCEPTION] {ex}");
			ErrorMessage = $"データの取得中にエラーが発生しました:{ex.Message}";
			ShohinList = new List<ShohinModel>();
		}
		finally
		{
			IsLoading = false;
		}
	}

	/// <summary>
	/// 商品管理メニュー画面に戻る処理
	/// </summary>
	private void GoBack()
	{
		NavManager.NavigateTo("/shohin/menu");
	}
}
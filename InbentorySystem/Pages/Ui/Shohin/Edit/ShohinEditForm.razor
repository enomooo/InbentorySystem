@page "/shohin/edit/form"
@using InbentorySystem.Data
@using InbentorySystem.Infrastructure.Interfaces
@using InbentorySystem.Infrastructure.Models
@using InbentorySystem.Services
@using InbentorySystem.Data.Models
@using InbentorySystem.Services.Interfaces
@inject IShohinService ShohinService
@inject NavigationManager NavManager
@inject IShohinRepository ShohinRepo
@inject IShiiresakiRepository ShiiresakiRepo

<h1>商品修正フォーム</h1>

@{
	<h2>選択された商品一覧</h2>
	@if (EditModel == null)
	{
		<div class="alert alert-warning">
			修正対象が選択されていません。<a href="/shohin/menu">商品管理メニューに戻る</a>
		</div>
	}
	else
	{
		<table class="table table-bordered table-striped">
			<thead>
				<tr>
					<th>商品コード</th>
					<th>商品名（漢字）</th>
					<th>商品名（かな）</th>
					<th class="text-end">仕入値</th>
					<th class="text-end">売値</th>
					<th>仕入先コード</th>
				</tr>
			</thead>
			<tbody>
				@foreach (var item in ShohinList)
				{
					<tr>
						<td>@item.ShohinCode</td>
						<td>@item.ShohinMeiKanji</td>
						<td>@item.ShohinMeiKana</td>
						<td class="text-end">@item.Shiirene.ToString("N0")</td>
						<td class="text-end">@item.Urine.ToString("N0")</td>
						<td>@item.ShiiresakiCode</td>
					</tr>
				}
			</tbody>
		</table>
		<EditForm Model="@EditModel" OnValidSubmit="UpdateShohinAsync">
			<DataAnnotationsValidator />
			<ValidationSummary />

			<div class="card p-4">
				<div class="row mb-3">
					<label for="ShohinCode" class="col-sm-3 col-form-label">商品コード</label>
					<div class="col-sm-5">
						<InputText id="ShohinCode" @bind-Value="EditModel.ShohinCode" class="form-control" Disabled />
					</div>
				</div>

				<div class="row mb-3">
					<label for="KanjiName" class="col-sm-3 col-form-label">商品名（漢字）</label>
					<div class="col-sm-7">
						<InputText id="KanjiName" @bind-Value="NewModel.ShohinMeiKanji" class="form-control" />
						<ValidationMessage For="@(() => EditModel.ShohinMeiKanji)" />
					</div>
				</div>

				<div class="row mb-3">
					<label for="KanaName" class="col-sm-3 col-form-label">商品名（かな）</label>
					<div class="col-sm-7">
						<InputText id="KanaName" @bind-Value="NewModel.ShohinMeiKana" class="form-control" />
						<ValidationMessage For="@(() => EditModel.ShohinMeiKana)" />
					</div>
				</div>

				<div class="row mb-3">
					<label for="Shiirene" class="col-sm-3 col-form-label">仕入値</label>
					<div class="col-sm-3">
						<InputNumber id="Shiirene" @bind-Value="NewModel.Shiirene" class="form-control" />
						<ValidationMessage For="@(() => EditModel.Shiirene)" />
					</div>
				</div>

				<div class="row mb-3">
					<label for="Urine" class="col-sm-3 col-form-label">売値</label>
					<div class="col-sm-3">
						<InputNumber id="Urine" @bind-Value="NewModel.Urine" class="form-control" />
						<ValidationMessage For="@(() => EditModel.Urine)" />
					</div>
				</div>

				<div class="row mb-3">
					<label for="ShiiresakiCode" class="col-sm-3 col-form-label">仕入先コード</label>
					<div class="col-sm-4">
						<InputSelect id="ShiiresakiCode" @bind-Value="NewModel.ShiiresakiCode" class="form-select">
							@if (ShiiresakiList == null || !ShiiresakiList.Any())
							{
								<option value="@EditModel.ShiiresakiCode">データを読み込み中...</option>
							}
							else
							{
								@foreach (var shiiresaki in ShiiresakiList)
								{
									<option value="@shiiresaki.ShiiresakiCode">
										@shiiresaki.ShiiresakiCode : @shiiresaki.ShiiresakiMeiKanji
									</option>
								}
							}
						</InputSelect>
						<ValidationMessage For="@(() => EditModel.ShiiresakiCode)" />
					</div>
				</div>

				@if (!string.IsNullOrEmpty(ErrorMessage))
				{
					<div class="alert alert-danger mt-3">@ErrorMessage</div>
				}
				<div class="d-flex gap-3 mt-4">
					<button type="submit" class="btn btn-primary">修正を保存</button>
					<button type="button" class="btn btn-outline-secondary" @onclick="ResetShohin">リセット</button>
				</div>
			</div>
		</EditForm>
		<button class="btn btn-secondary w-100 mb-3" @onclick="GoBack">
			<span class="pointer-event oi-arrow-left"></span>商品管理メニューへ戻る
		</button>
	}
}

@code {

	private ShohinModel? EditModel;
	private string ErrorMessage = string.Empty;
	private List<ShiiresakiModel> ShiiresakiList { get; set; } = new();
	private List<ShohinModel> ShohinList = new();
	private ShohinModel NewModel = new();

	private ShohinModel Clone(ShohinModel source) => new()
	{
		ShohinCode = source.ShohinCode,
		ShohinMeiKanji = source.ShohinMeiKanji,
		ShohinMeiKana = source.ShohinMeiKana,
		Shiirene = source.Shiirene,
		Urine = source.Urine,
		ShiiresakiCode = source.ShiiresakiCode
	};

	/// <summary>
	/// 修正前EditModel => NewModelに入れる
	/// </summary>
	private void ResetShohin()
	{
		if (EditModel != null)
		{
			NewModel = Clone(EditModel);
		}
	}

	/// <summary>
	/// 選択された商品情報を取得
	/// </summary>
	protected override async Task OnInitializedAsync()
	{
		EditModel = ShohinService.GetLastEditedShohin();
		ShohinList = ShohinService.GetSearchResults();

		NewModel = new ShohinModel();

		await LoadShiiresakiDataAsync();
	}


	private async Task LoadShiiresakiDataAsync()
	{
		try
		{
			if (ShiiresakiRepo != null)
			{
				ShiiresakiList = await ShiiresakiRepo.GetAllAsync();
			}
		}
		catch (Exception ex)
		{
			ErrorMessage = $"仕入先データのロード中にエラーが発生しました: {ex.Message}";
			ShiiresakiList = new List<ShiiresakiModel>();
		}
	}

	/// <summary>
	/// 商品情報を更新する
	/// </summary>
	/// <returns></returns>
	private async Task UpdateShohinAsync()
	{
		ErrorMessage = string.Empty;

		if (EditModel == null)
		{
			ErrorMessage = "修正対象の商品が存在しません。";
			return;
		}

		try
		{
			await ShohinRepo.UpdateAsync(NewModel);
			ShohinService.SetLastUpdatedShohin(NewModel);
			ShohinService.SetLastEditedShohin(NewModel);
			NavManager.NavigateTo("/shohin/edit/result");
		}
		catch (Exception ex)
		{
			ErrorMessage = $"修正中にエラーが発生しました: {ex.Message}";
		}
	}

	/// <summary>
	/// 商品管理メニュー画面に戻る処理
	/// </summary>
	private void GoBack()
	{
		ShohinService.ClearLastRegisteredShohin();
		NavManager.NavigateTo("/shohin/menu");
	}
}
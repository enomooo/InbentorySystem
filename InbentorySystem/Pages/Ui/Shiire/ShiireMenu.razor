@page "/shohin/menu"
@using InbentorySystem.Data.Models
@using InbentorySystem.Infrastructure
@using InbentorySystem.Infrastructure.Interfaces
@using InbentorySystem.Infrastructure.Models
@using InbentorySystem.Services
@using InbentorySystem.Services.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@inject IShiireRepository ShohinRepo
@inject NavigationManager NavManager
@inject IShiiresakiRepository ShiiresakiRepo



<PageTitle>仕入管理メニュー</PageTitle>

<h1>仕入管理メニュー</h1>

@* --メッセージ表示エリア--*@
@if (!string.IsNullOrEmpty(Message))
{
	<div class="@(IsError ? "alert alert-danger" : "alert alert-info")" role="alert">@Message</div>
}

@* 検索エリア*@
<div class="card p-4 shadow-sm mb-4">
	<h2>仕入検索</h2>
	<div class="row mb-3">

		@* 仕入年月*@
		<div class="col-md-3">
			<label for="dateFromSearch" class="form-label">仕入年月日 From</label>
			<input type="string" class="form-control" id="dateFromSearch" @bind="DateFrom" />
		</div>

		@* 商品コード *@
		<div class="col-md-3">
			<label for="codeKeywordSearch" class="form-label">商品コード</label>
			<input type="text" class="form-control" id="codeKeywordSearch" @bind="CodeKeyword" placeholder="商品コードの一部を入力" />
		</div>
	</div>
	<div class="d-flex gap-2 mt-4">
		<button type="button" class="btn btn-primary" @onclick='() => SearchAndNavigate("Search")'>
			<i class="bi bi-search"></i> 検索
		</button>
		<button type="button" class="btn btn-secondary" @onclick="ResetSearchForm">リセット</button>
	</div>
</div>
<hr class="mt-4" />

@* 新規仕入登録エリア *@
<div class="card p-4　shadow-sm mb-4">
	<h2>新規仕入登録</h2>

	<EditForm Model="@NewShiireModel" OnValidSubmit="NewShiireRegistrationAsync">
		<DataAnnotationsValidator />

		@* 仕入日付 *@
		<div class="row mb-3">
			<label for="ShiireNengappi" class="col-sm-3 col-form-label">仕入日付</label>
			<div class="col-sm-5">
				<InputDate id="ShiireNengappi" @bind-Value="NewShiireModel.ShiireNengappi" class="form-control" />
				<ValidationMessage For="@(() => NewShiireModel.ShiireNengappi)" />
			</div>
		</div>

		@* 商品コード *@
		<div class="row mb-3">
			<label for="ShohinCode" class="col-sm-3 col-form-label">商品コード</label>
			<div class="col-sm-5">
				<InputText id="ShohinCode" @bind-Value="NewShiireModel.ShohinCode" class="form-control" />
				<ValidationMessage For="@(() => NewShiireModel.ShohinCode)" />
			</div>
		</div>

		@* 仕入先コード *@
		<div class="row mb-3">
			<label for="ShiiresakiCode" class="col-sm-3 col-form-label">仕入先コード</label>
			<div class="col-sm-5">
				<InputText id="ShiiresakiCode" @bind-Value="NewShiireModel.ShiiresakiCode" class="form-control" />
				<ValidationMessage For="@(() => NewShiireModel.ShiiresakiCode)" />
			</div>
		</div>

		@* 数量 *@
		<div class="row mb-3">
			<label for="Quantity" class="col-sm-3 col-form-label">数量</label>
			<div class="col-sm-3">
				@* InputNumber を使用し、数値型にバインド *@
				<InputNumber id="Quantity" @bind-Value="NewShiireModel.Quantity" class="form-control" />
				<ValidationMessage For="@(() => NewShiireModel.Quantity)" />
			</div>
		</div>

		@* 仕入値 *@
		<div class="row mb-3">
			<label for="Shiirene" class="col-sm-3 col-form-label">仕入値</label>
			<div class="col-sm-3">
				@* InputNumberを使用し、数値型にバインド *@
				<InputNumber id="Shiirene" @bind-Value="NewShiireModel.Shiirene" class="form-control" />
				<ValidationMessage For="@(() => NewShiireModel.Shiirene)" />
			</div>
		</div>

		<div class="d-flex gap-3 mt-4">
			@* type="submit"でNewShiireRegistrationAsyncが呼ばれる*@
			<button type="submit" class="btn btn-success">
				<i class="bi bi-box-arrow-in-down"></i> 仕入登録
			</button>
			<button type="button" class="btn btn-secondary" @onclick="ResetNewForm">
				<i class="bi bi-x-octagon"></i> リセット
			</button>
		</div>

		@if (!string.IsNullOrEmpty(RegisterErrorMessage))
		{
			<div class="alert alert-danger mt-3">@RegisterErrorMessage</div>
		}
	</EditForm>
</div>
<hr class="mt-4" />

@* 仕入修正エリア*@
<div class="card p-4 shadow-sm mb-4">
	<h2>仕入修正</h2>
	<p class="text-muted">検索条件を入力し、「修正画面へ」を押してください。</p>
	<div class="d-flex gap-2">
		<button type="button" class="btn btn-warning" @onclick='() => SearchAndNavigate("Edit")'>
			<i class="bi bi-pencil-square"></i> 修正画面へ
		</button>
		<button type="button" class="btn btn-secondary" @onclick="ResetSearchForm">リセット</button>
	</div>
</div>
<hr class="mt-4" />

@* 仕入削除エリア*@
<div class="card p-4 shadow-sm mb-4">
	<h2>仕入削除</h2>
	<p class="text-muted">検索条件を入力し、「削除画面へ」を押してください。</p>
	<div class="d-flex gap-2">
		<button type="button" class="btn btn-warning" @onclick='() => SearchAndNavigate("Delete")'>
			<i class="bi bi-pencil-square"></i> 削除画面へ
		</button>
		<button type="button" class="btn btn-secondary" @onclick="ResetSearchForm">リセット</button>
	</div>
</div>

<button class="btn btn-secondary w-100" @onclick="GoBack">ホームメニューに戻る</button>

@code {
	// 依存性注入
	[Inject]
	public IShiireRepository ShiireRepository { get; set; } = default!;
	[Inject]
	public IShiireService ShiireService { get; set; } = default!;
	[Inject]
	public NavigationManager NavigationManager { get; set; } = default!;

	// 検索条件を保持するプロパティ
	private string? DateFrom { get; set; }
	private string? DateTo { get; set; }
	private string? CodeKeyword { get; set; }

	// UI表示用
	private string? Message { get; set; }
	private bool IsError { get; set; }

	// 新規仕入登録で使用するプロパティ
	private ShiireModel NewShiireModel { get; set; } = new();
	private string? RegisterErrorMessage { get; set; }

	/// <summary>
	/// 検索機能の結果画面にNaviするメソッド
	/// </summary>
	/// <param name="actionType">どのフォームに書かれたか</param>
	/// <returns></returns>
	private async Task SearchAndNavigate(string actionType)
	{
		Message = null;
		IsError = false;

		try
		{
			var results = await ShiireRepository.SearchAsync
			(
			DateFrom ?? string.Empty,
			DateTo ?? string.Empty,
			CodeKeyword ?? string.Empty
			);

			var uri = ShiireService.DetermineNavigationUri
			(
			DateFrom ?? string.Empty,
			CodeKeyword ?? string.Empty,
			results,
			actionType
			);

			if (uri != null)
			{
				NavigationManager.NavigateTo(uri);
			}

			else
			{
				Message = "該当データが見つかりませんでした";
				IsError = false;
			}
		}

		catch (ApplicationException ex)
		{
			Message = $"検索中にエラーが発生しました: {ex.Message}";
			IsError = true;
		}

		catch (Exception ex)
		{
			Message = "システムエラーが発生しました。";
			IsError = true;
			Console.WriteLine(ex.ToString());
		}
	}

	private void ResetSearchForm()
	{
		DateFrom = null;
		DateTo = null;
		CodeKeyword = string.Empty;
		Message = null;
		IsError = false;
	}

	private async Task NewShiireRegistrationAsync()
	{
		RegisterErrorMessage = null;

		try
		{
			var affectedRows = await ShiireRepository.RegisterAsync(NewShiireModel);

			if (affectedRows > 0)
			{
				Message = $"仕入伝票(商品コード: {NewShiireModel.ShohinCode}の登録と在庫調整が完了しました。";
				IsError = false;
				NavigationManager.NavigateTo("/shiire/index", forceLoad: true);
				ResetNewForm();
			}
			else
			{
				RegisterErrorMessage = "登録処理が正常に完了しませんでした。影響を受けた行数が0です";
			}
		}
		catch (InvalidOperationException ex)
		{
			RegisterErrorMessage = $"登録中にシステムエラーが発生しました: {ex.Message}";
			Console.WriteLine(ex.ToString());
		}
	}

	/// <summary>
	/// 新規登録フォームをリセットする
	/// </summary>
	private void ResetNewForm()
	{
		NewShiireModel = new ShiireModel();
		RegisterErrorMessage = null;
	}

	private void NavigateToRegister()
	{
		NavManager.NavigateTo("/shiire/register");
	}

	/// <summary>
	/// Homeメニュー画面に戻る処理
	/// </summary>
	private void GoBack()
	{
		NavManager.NavigateTo("/");
	}
}
}

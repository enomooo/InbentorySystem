@page "/shohin/menu"
@using InbentorySystem.Data
@using InbentorySystem.Data.Models
@using InbentorySystem.Infrastructure.Interfaces
@using InbentorySystem.Services
@inject IShohinRepository ShohinRepo
@inject NavigationManager NavManager
@inject IShohinService ShohinService
@using InbentorySystem.Services.Interfaces
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>商品管理メニュー</PageTitle>

<h1>商品管理メニュー</h1>

@* 検索・修正・削除共通のエラーメッセージ表示エリア*@
@if (!string.IsNullOrEmpty(ErrorMessage))
{
	<div class="alert alert-danger">@ErrorMessage</div>
}

@* 商品検索エリア*@
<div class="card p-4 mb-4">
	<h2>商品検索</h2>
	<div class="row mb-3">
		<label for="searchKeyword" class="col-sm-3 col-form-label">商品名検索</label>
		<div class="col-sm-6">
			<input id="searchKeyword" class="form-control" @bind="SearchKeyword" placeholder="検索する商品名を入力してください。" />
		</div>
	</div>
	<div class="d-flex gap-2">
		<button class="btn btn-info" @onclick="@(() => SearchAndNavigate(SearchKeyword))">検索</button>
		<button class="btn btn-secondary" @onclick="@(ResetForm)">リセット</button>
	</div>
</div>
<hr class="mt-4" />

@* 新規商品登録エリア*@
<div class="card p-4">
	<h2>新規商品登録</h2>
	<EditForm Model="@NewModel" OnValidSubmit="NewShohinRegistrationAsync">
		<DataAnnotationsValidator />

		<div class="card p-4">
			<div class="row mb-3">
				<label for="ShohinCode" class="col-sm-3 col-form-label">商品コード</label>
				<div class="col-sm-5">
					<InputText id="ShohinCode" @bind-Value="NewModel.ShohinCode" class="form-control" />
					<ValidationMessage For="@(() => NewModel.ShohinCode)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="KanjiName" class="col-sm-3 col-form-label">商品名（漢字）</label>
				<div class="col-sm-7">
					<InputText id="KanjiName" @bind-Value="NewModel.ShohinMeiKanji" class="form-control" />
					<ValidationMessage For="@(() => NewModel.ShohinMeiKanji)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="KanaName" class="col-sm-3 col-form-label">商品名（かな）</label>
				<div class="col-sm-7">
					<InputText id="KanaName" @bind-Value="NewModel.ShohinMeiKana" class="form-control" />
					<ValidationMessage For="@(() => NewModel.ShohinMeiKana)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="Shiirene" class="col-sm-3 col-form-label">仕入値</label>
				<div class="col-sm-3">
					<InputNumber id="Shiirene" @bind-Value="NewModel.Shiirene" class="form-control" />
					<ValidationMessage For="@(() => NewModel.Shiirene)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="Urine" class="col-sm-3 col-form-label">売値</label>
				<div class="col-sm-3">
					<InputNumber id="Urine" @bind-Value="NewModel.Urine" class="form-control" />
					<ValidationMessage For="@(() => NewModel.Urine)" />
				</div>
			</div>

			<div class="row mb-3">
				<label for="ShiiresakiCode" class="col-sm-3 col-form-label">仕入先コード</label>
				<div class="col-sm-4">
					<InputText id="ShiiresakiCode" @bind-Value="NewModel.ShiiresakiCode" class="form-control" />
					<ValidationMessage For="@(() => NewModel.ShiiresakiCode)" />
				</div>
			</div>

			<div class="card p-4">
				<div class="d-flex gap-3 mt-4">
					@* type="submit"でRegisterAsyncが呼ばれる*@
					<button type="submit" class="btn btn-success">登録画面</button>
					<button type="button" class="btn btn-secondary" @onclick="ResetNewForm">フォームリセット</button>
				</div>
				@if (!string.IsNullOrEmpty(RegisterErrorMessage))
				{
					<div class="alert alert-danger mt-3">@RegisterErrorMessage</div>
				}
			</div>
		</div>
	</EditForm>
</div>
<hr class="mt-4" />

@* 商品修正エリア*@
<div class="card p-4 mb-4">
	<h2>商品修正</h2>
	<div class="row mb-3">
		<label for="editKeyword" class="col-sm-3 col-form-label">商品名検索</label>
		<div class="col-sm-6">
			<input id="editKeyword" class="form-control" @bind="EditSearchKeyword" placeholder="修正対象の商品名を入力してください。" />
		</div>
	</div>
	<div class="d-flex gap-2">
		<button class="btn btn-warning" @onclick="@(() => SearchForEdit(EditSearchKeyword))">修正画面へ</button>
		<button class="btn btn-secondary" @onclick="@(ResetEditForm)">リセット</button>
	</div>
</div>
<hr class="mt-4" />

@* 商品削除エリア*@
<div class="card p-4 mb-4">
	<h2>商品削除</h2>
	<div class="row mb-3">
		<label for="deleteKeyword" class="col-sm-3 col-form-label">商品名検索</label>
		<div class="col-sm-6">
			<input id="deleteKeyword" class="form-control" @bind="DeleteSearchKeyword" placeholder="削除対象の商品名を入力してください。" />
		</div>
	</div>
	<div class="d-flex gap-2">
		<button class="btn btn-danger" @onclick="@(() => SearchForDelete(DeleteSearchKeyword))">削除画面へ</button>
		<button class="btn btn-secondary" @onclick="@(ResetDeleteForm)">リセット</button>
	</div>
</div>
<hr class="mt-4" />

<button class="btn btn-secondary" @onclick="GoBack">ホームメニューに戻る</button>

@code {
	// 各機能ごとのキーワードを保持するフィールド
	private string SearchKeyword = string.Empty;
	private string EditSearchKeyword = string.Empty;
	private string DeleteSearchKeyword = string.Empty;

	// エラーメッセージを保持するフィールド
	private string ErrorMessage = string.Empty;
	private string RegisterErrorMessage = string.Empty;

	// 新規登録フォームとバインドされるモデル
	private ShohinModel NewModel = new();

	/// <summary>
	/// SearchAndNavigeateメソッドで実行する処理の種別を定義
	/// </summary>
	private enum ActionType
	{
		Search,
		Edit,
		Delete
	}

	/// <summary>
	/// 商品名キーワードに基づいて検索を実行し、検索結果に応じて画面遷移を行う
	/// </summary>
	/// <param name="keyword">検索キーワード</param>
	/// <returns></returns>
	private async Task SearchAndNavigate(string keyword)
	{
		ErrorMessage = string.Empty;
		List<ShohinModel> results = new();

		try
		{
			// キーワード未入力時は全件取得
			if (string.IsNullOrWhiteSpace(keyword))
			{
				results = await ShohinRepo.GetAllAsync();
			}

			// キーワード入力時は部分一致検索
			else
			{
				results = await ShohinRepo.SearchByKeywordAsync(keyword);
			}

			var targetUrl = ShohinService.GetNavigationUri(keyword);

			// 該当商品がない場合、エラーメッセージを表示して終了(return == 0)
			if (string.IsNullOrEmpty(targetUrl))
			{
				ErrorMessage = "該当する商品がありませんでした。";
			}

			// returnが1以上なら検索画面に遷移
			else
			{
				NavManager.NavigateTo(targetUrl);
			}
		}
		catch (Exception ex)
		{
			ErrorMessage = $"エラーが発生しました: {ex.Message}";
		}
	}

	/// <summary>
	/// 検索フォームリセット
	/// </summary>
	private void ResetForm()
	{
		SearchKeyword = string.Empty;
		ErrorMessage = string.Empty;
	}

	/// <summary>
	/// 修正フォームリセット
	/// </summary>
	private void ResetEditForm()
	{
		SearchKeyword = string.Empty;
		ErrorMessage = string.Empty;
	}

	/// <summary>
	/// 削除フォームリセット
	/// </summary>
	private void ResetDeleteForm()
	{
		SearchKeyword = string.Empty;
		ErrorMessage = string.Empty;
	}

	/// <summary>
	/// 新規商品登録処理
	/// </summary>
	private async Task NewShohinRegistrationAsync()
	{
		RegisterErrorMessage = string.Empty;
		try
		{
			// 重複チェック
			bool isDuplicate = await ShohinRepo.CheckDuplicateCodeAsync(NewModel.ShohinCode);
			if (isDuplicate)
			{
				RegisterErrorMessage = "この商品コードは既に登録されています";
				return;
			}

			// 登録実行
			await ShohinRepo.RegisterAsync(NewModel);

			// 実行後の処理
			NewModel = new ShohinModel();
			NavManager.NavigateTo("/shohin/menu", forceLoad: true);
		}
		catch (Exception ex)
		{
			RegisterErrorMessage = $"登録中にシステムエラーが発生しました: {ex.Message}";
		}
	}

	/// <summary>
	// 登録フォームのリセット処理
	/// </summary>
	private void ResetNewForm()
	{
		NewModel = new ShohinModel();
		RegisterErrorMessage = string.Empty;
		StateHasChanged();
	}

	/// <summary>
	/// 修正欄の商品を検索して結果があれば修正選択画面へ遷移
	/// </summary>
	/// <param name="keyword">修正欄のキーワード</param>
	/// <returns>修正url</returns>
	private async Task SearchForEdit(string keyword)
	{
		ErrorMessage = string.Empty;
		var results = string.IsNullOrWhiteSpace(keyword)
			? await ShohinRepo.GetAllAsync()
			: await ShohinRepo.SearchByKeywordAsync(keyword);

		ShohinService.SetSearchResults(results);

		if (results.Count == 0)
		{
			ErrorMessage = "該当する商品がありませんでした。";
		}
		else
		{
			NavManager.NavigateTo("/shohin/edit/select");
		}
	}

	/// <summary>
	/// 削除欄の商品を検索して結果があれば削除選択画面へ遷移
	/// </summary>
	/// <param name="keyword">削除欄のキーワード</param>
	/// <returns>削除url</returns>
	private async Task SearchForDelete(string keyword)
	{
		ErrorMessage = string.Empty;
		var results = string.IsNullOrWhiteSpace(keyword)
			? await ShohinRepo.GetAllAsync()
			: await ShohinRepo.SearchByKeywordAsync(keyword);

		ShohinService.SetSearchResults(results);

		if (results.Count == 0)
		{
			ErrorMessage = "該当する商品がありませんでした。";
		}
		else
		{
			NavManager.NavigateTo("/shohin/delete/select");
		}
	}

	/// <summary>
	/// Homeメニュー画面に戻る処理
	/// </summary>
	private void GoBack()
	{
		NavManager.NavigateTo("/");
	}
}